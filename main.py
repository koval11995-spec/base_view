import streamlit as st
import json
import pandas as pd
from typing import Dict, List, Optional


class TreatmentPlanner:
    def __init__(self, knowledge_base_path: Optional[str] = None):
        """Инициализация системы планирования лечения"""
        if knowledge_base_path:
            self.load_knowledge_base(knowledge_base_path)
        else:
            # Используем предоставленные данные
            self.knowledge_base = {
   "disease":[
      {
         "name":"Переломы проксимального отдела бедренной кости",
         "type_variant":[
            {
               "name":"Переломы головки бедренной кости",
               "ICD-10_code":"S72.0",
               "general_indications":[
                  "Переломы головки бедренной кости у пациентов моложе 60 лет (все типы по классификации Pipkin)",
                  "Переломы головки бедренной кости у пациентов старше 60 лет (все типы по классификации Pipkin)"
               ],
               "general_contraindications":[
                  
               ],
               "stage":[
                  {
                     "name_stage":"Хирургическое лечение у пациентов моложе 60 лет",
                     "methods":[
                        {
                           "name":"Удаление фрагмента головки",
                           "criteria":{
                              "indications":[
                                 "Переломы типа Pipkin I у пациентов всех возрастных групп",
                                 "У пациентов моложе 60 лет как метод выбора",
                                 "У пациентов старше 60 лет как метод выбора",
                                 "Переломы типа Pipkin IV в комбинации с остеосинтезом вертлужной впадины, если перелом головки соответствует критериям Pipkin I (расположен дистальнее ямки головки бедренной кости)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Артроскопическое удаление фрагмента головки",
                           "criteria":{
                              "indications":[
                                 "Переломы головки бедренной кости типа Pipkin I (переломы дистальнее ямки головки бедренной кости)",
                                 "Пациенты моложе 60 лет",
                                 "Пациенты старше 60 лет",
                                 "У пациентов моложе 60 лет операция может быть выполнена в плановом порядке"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "артроскоп (эндоскопический инструмент с видеокамерой)"
                              ]
                           }
                        },
                        {
                           "name":"Остеосинтез фрагментов головки канюлированными компрессирующими винтами с возможностью субхондрального погружения",
                           "criteria":{
                              "indications":[
                                 "Переломы головки бедренной кости типа Pipkin II у пациентов моложе 60 лет",
                                 "Переломы головки бедренной кости типа Pipkin IV у пациентов моложе 60 лет (в комбинации с остеосинтезом вертлужной впадины, если перелом головки относится к типу II)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "канюлированные компрессирующие винты",
                                 "направляющая спица"
                              ]
                           }
                        },
                        {
                           "name":"Первичное тотальное эндопротезирование тазобедренного сустава (ЭТСТ)",
                           "criteria":{
                              "indications":[
                                 "Переломы Pipkin III у пациентов моложе 60 лет",
                                 "Переломы Pipkin II и Pipkin III у пациентов старше 60 лет",
                                 "Переломы Pipkin IV в комбинации с остеосинтезом вертлужной впадины"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "бесцементная фиксация",
                                 "гибридная фиксация"
                              ]
                           }
                        },
                        {
                           "name":"Остеосинтез вертлужной впадины",
                           "criteria":{
                              "indications":[
                                 "Переломы типа Pipkin IV: Переломы головки бедренной кости, сочетающиеся с переломом вертлужной впадины",
                                 "У пациентов моложе 60 лет: При переломах головки дистальнее ямки (Pipkin I) — в сочетании с удалением фрагмента головки",
                                 "У пациентов моложе 60 лет: При переломах головки проксимальнее ямки (Pipkin II) — в сочетании с остеосинтезом фрагментов головки",
                                 "У пациентов старше 60 лет — в сочетании с тотальным эндопротезированием тазобедренного сустава (ЭТСТ)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        }
                     ]
                  },
                  {
                     "name_stage":"Хирургическое лечение у пациентов старше 60 лет",
                     "methods":[
                        {
                           "name":"Удаление фрагмента головки бедренной кости",
                           "criteria":{
                              "indications":[
                                 "Переломы головки бедренной кости типа Pipkin I (отрыв фрагмента дистальнее ямки головки бедренной кости)",
                                 "У пациентов моложе 60 лет (метод выбора)",
                                 "У пациентов старше 60 лет (метод выбора для переломов Pipkin I)",
                                 "В рамках комбинированной травмы (Pipkin IV) в сочетании с остеосинтезом вертлужной впадины, если перелом головки соответствует типу I (дистальнее ямки)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Тотальное эндопротезирование тазобедренного сустава (ЭТСТ)",
                           "criteria":{
                              "indications":[
                                 "Переломы головки бедренной кости по классификации Pipkin III у пациентов моложе 60 лет",
                                 "Переломы головки бедренной кости по классификации Pipkin II и III у пациентов старше 60 лет",
                                 "Переломы головки бедренной кости по классификации Pipkin IV у пациентов старше 60 лет (в сочетании с остеосинтезом перелома вертлужной впадины)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "Эндопротез тазобедренного сустава",
                                 "Компоненты для бесцементной или гибридной фиксации",
                                 "Материалы для остеосинтеза вертлужной впадины (при Pipkin IV)"
                              ]
                           }
                        },
                        {
                           "name":"Остеосинтез перелома вертлужной впадины",
                           "criteria":{
                              "indications":[
                                 "У пациентов моложе 60 лет с переломом типа Pipkin IV",
                                 "У пациентов старше 60 лет с переломом типа Pipkin IV (в комбинации с эндопротезированием)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"ЭТСТ с использованием бесцементной или гибридной фиксации",
                           "criteria":{
                              "indications":[
                                 "переломы головки бедренной кости типа Pipkin IV у пациентов старше 60 лет"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "искусственный эндопротез тазобедренного сустава",
                                 "компоненты эндопротеза с пористым покрытием (для бесцементной фиксации)",
                                 "костный цемент (для гибридной фиксации, если применяется)",
                                 "имплантаты для остеосинтеза вертлужной впадины"
                              ]
                           }
                        }
                     ]
                  },
                  {
                     "name_stage":"Послеоперационное восстановление (Реабилитация и режим нагрузки)",
                     "methods":[
                        {
                           "name":"Дозированная нагрузка весом тела",
                           "criteria":{
                              "indications":[
                                 "После удаления фрагментов головки бедренной кости (Pipkin I)",
                                 "После остеосинтеза (фиксации отломков винтами) при переломах Pipkin I, II, IV (после 12 недель)",
                                 "После эндопротезирования, сочетающегося с остеосинтезом вертлужной впадины (Pipkin IV у пациентов старше 60 лет, после 12 недель)"
                              ],
                              "contraindications":[
                                 "После остеосинтеза (фиксации отломков винтами) при переломах Pipkin I, II, IV (первые 12 недель)",
                                 "После эндопротезирования, сочетающегося с остеосинтезом вертлужной впадины (Pipkin IV у пациентов старше 60 лет, первые 12 недель)"
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Исключение нагрузки весом тела на срок 12 недель",
                           "criteria":{
                              "indications":[
                                 "После остеосинтеза (сопоставления и фиксации отломков) при переломах Pipkin I, II, IV (когда выполнен остеосинтез фрагментов головки и/или вертлужной впадины)",
                                 "После комбинированной операции при эндопротезировании тазобедренного сустава (ЭТСТ), которое сочеталось с остеосинтезом вертлужной впадины (актуально для переломов Pipkin IV у пациентов старше 60 лет)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "костыли",
                                 "ходунки"
                              ]
                           }
                        },
                        {
                           "name":"Полная нагрузка весом тела",
                           "criteria":{
                              "indications":[
                                 "После тотального эндопротезирования тазобедренного сустава (ЭТСТ), выполненного по поводу переломов головки бедренной кости типа Pipkin II у пациентов старше 60 лет",
                                 "После тотального эндопротезирования тазобедренного сустава (ЭТСТ), выполненного по поводу переломов головки бедренной кости типа Pipkin III (сочетающихся с переломом шейки бедра) у пациентов любого возраста (моложе и старше 60 лет)"
                              ],
                              "contraindications":[
                                 "Сочетание эндопротезирования с остеосинтезом вертлужной впадины (например, при переломах типа Pipkin IV)",
                                 "После операций остеосинтеза (фиксации отломков винтами) или удаления фрагментов головки бедра, где требуется период разгрузки или дозированной нагрузки"
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Дыхательные упражнения",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Активные упражнения для суставов здоровой ноги",
                           "criteria":{
                              "indications":[
                                 "ранняя послеоперационная реабилитация",
                                 "проведение всем пациентам без исключения"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Изометрические упражнения для мышц оперированной конечности",
                           "criteria":{
                              "indications":[
                                 "С первого дня после операции (в рамках ранней послеоперационной реабилитации)",
                                 "Всем пациентам после хирургического лечения переломов головки бедренной кости (типы Pipkin I-IV), независимо от вида выполненной операции (удаление фрагмента, остеосинтез или эндопротезирование)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Роботизированная механотерапия",
                           "criteria":{
                              "indications":[
                                 "ранняя послеоперационная реабилитация после хирургического лечения переломов головки бедренной кости (классификация Pipkin)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Обучение приподниманию таза",
                           "criteria":{
                              "indications":[
                                 "ранняя послеоперационная реабилитация после хирургического лечения переломов головки бедренной кости (классификация Pipkin)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Вертикализация пациента с опорой (ходунки, костыли) под контролем инструктора",
                           "criteria":{
                              "indications":[
                                 "всем пациентам после хирургического лечения перелома по классификации Pipkin"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "ходунки",
                                 "костыли"
                              ]
                           }
                        },
                        {
                           "name":"Обучение ходьбе с дополнительными средствами опоры",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "ходунки",
                                 "костыли"
                              ]
                           }
                        },
                        {
                           "name":"Медицинский массаж оперированной конечности",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Физиотерапия (СМТ-терапия, магнитотерапия)",
                           "criteria":{
                              "indications":[
                                 "при наличии болевого синдрома"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Рефлексотерапия",
                           "criteria":{
                              "indications":[
                                 "наличие болевого синдрома"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Функциональная многоканальная стимуляция мышц во время ходьбы (ФМСМ)",
                           "criteria":{
                              "indications":[
                                 "Проводится в позднем послеоперационном периоде (с 7-15 дня до 10-12 недель после операции) у пациентов после хирургического лечения переломов головки бедренной кости"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "Электростимулятор",
                                 "Электроды для многоканальной стимуляции"
                              ]
                           }
                        }
                     ]
                  }
               ]
            },
            {
               "name":"Переломы шейки бедренной кости",
               "ICD-10_code":"S72.0",
               "general_indications":[
                  "Переломы шейки бедренной кости (ШБК) у пациентов старше 60 лет (рекомендуется оперативное лечение не позднее 48 часов после поступления в стационар при отсутствии медицинских противопоказаний)",
                  "Переломы Garden I-II (Pauwels I) – вальгусные, вколоченные, без смещения (метод выбора – остеосинтез)",
                  "Переломы Garden III-IV (Pauwels II-III) – со смещением у пациентов моложе 60 лет (метод выбора – остеосинтез)",
                  "Переломы Garden III-IV (Pauwels II-III) – со смещением у пациентов старше 60 лет (метод выбора – эндопротезирование тазобедренного сустава)",
                  "Функционально активные пациенты старше 60 лет с активным образом жизни до травмы (показано тотальное эндопротезирование – ЭТСТ)",
                  "Пациенты старческого возраста с выраженными когнитивными нарушениями, низким уровнем двигательной активности, тяжелой соматической патологией (показано гемиэндопротезирование)"
               ],
               "general_contraindications":[
                  "Наличие медицинских противопоказаний (не указаны конкретно в тексте, но подразумеваются как факторы, препятствующие операции в течение 48 часов)",
                  "Использование трехлопастных гвоздей или Г-образных пластин при переломах Garden I-II (не рекомендуется)",
                  "Использование пары трения металл-металл при эндопротезировании (не рекомендуется)"
               ],
               "stage":[
                  {
                     "name_stage":"Хирургическое лечение",
                     "methods":[
                        {
                           "name":"Остеосинтез",
                           "criteria":{
                              "indications":[
                                 "Переломы Garden I-II (Pauwels I) – вальгусные, вколоченные, без смещения для всех возрастных групп",
                                 "Переломы Garden III-IV (Pauwels II-III) – со смещением у пациентов моложе 60 лет",
                                 "Переломы Garden III-IV (Pauwels II-III) – со смещением у пациентов старше 60 лет с высоким риском осложнений от эндопротезирования"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "спонгиозные канюлированные винты с шайбами",
                                 "система динамического бедренного винта (DHS)",
                                 "три винта костных динамических, введенных параллельно и фиксированных в пластине"
                              ]
                           }
                        },
                        {
                           "name":"Эндопротезирование тазобедренного сустава",
                           "criteria":{
                              "indications":[
                                 "Пациенты старше 60 лет с переломами шейки бедренной кости Garden III-IV (со смещением)",
                                 "Функционально активные пациенты старше 60 лет с активным образом жизни до травмы, которые могут передвигаться самостоятельно и не имеют выраженных когнитивных нарушений (для тотального эндопротезирования)",
                                 "Пациенты старческого возраста с выраженными когнитивными нарушениями, низким уровнем двигательной активности и тяжелой соматической патологией (для гемиэндопротезирования)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "керамика",
                                 "полиэтилен",
                                 "металл",
                                 "костный цемент",
                                 "винты",
                                 "пластина"
                              ]
                           }
                        },
                        {
                           "name":"Тотальное эндопротезирование (ЭТСТ)",
                           "criteria":{
                              "indications":[
                                 "Функционально активные пациенты старше 60 лет",
                                 "Активный образ жизни и способность к самостоятельному передвижению до получения травмы (перелома шейки бедренной кости)",
                                 "Отсутствие выраженных когнитивных нарушений",
                                 "Переломы со смещением (Garden III-IV)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "цементные компоненты эндопротеза",
                                 "бесцементные компоненты эндопротеза",
                                 "керамика",
                                 "полиэтилен",
                                 "металл"
                              ]
                           }
                        },
                        {
                           "name":"Гемиэндопротезирование",
                           "criteria":{
                              "indications":[
                                 "Пациенты старческого возраста",
                                 "Выраженные когнитивные нарушения (например, деменция)",
                                 "Низкий уровень двигательной активности до травмы",
                                 "Тяжелая соматическая патология (сопутствующие заболевания, повышающие риск операции)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "искусственный имплантат (головка и шейка бедренной кости)",
                                 "цемент или бесцементные компоненты для фиксации",
                                 "биполярные головки с парами трения: керамика-полиэтилен или металл-полиэтилен"
                              ]
                           }
                        }
                     ]
                  },
                  {
                     "name_stage":"Послеоперационное восстановление и реабилитация",
                     "methods":[
                        {
                           "name":"Ранний послеоперационный период",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Поздний послеоперационный период",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        }
                     ]
                  }
               ]
            },
            {
               "name":"Чрезвертельные переломы",
               "ICD-10_code":"S72.1",
               "general_indications":[
                  "Чрезвертельные переломы (внекапсульные переломы вертельной области бедренной кости, кодировка по МКБ-10: S72.1, классификация AO/OTA: 31A)"
               ],
               "general_contraindications":[
                  "Медицинские противопоказания (не указаны конкретно в тексте, но упоминаются как фактор, влияющий на сроки операции)"
               ],
               "stage":[
                  {
                     "name_stage":"Предоперационная подготовка",
                     "methods":[
                        
                     ]
                  },
                  {
                     "name_stage":"Анестезия",
                     "methods":[
                        
                     ]
                  },
                  {
                     "name_stage":"Хирургическое лечение",
                     "methods":[
                        {
                           "name":"Остеосинтез системой динамического бедренного винта (DHS)",
                           "criteria":{
                              "indications":[
                                 "Хирургическое лечение стабильных чрезвертельных переломов проксимального отдела бедренной кости",
                                 "Двухфрагментарный чрезвертельный перелом, где медиальная опора интактна (тип 31А1.2 по классификации AO/OTA)"
                              ],
                              "contraindications":[
                                 "Нестабильные чрезвертельные переломы (например, типов 31А1.3, 31A2 по AO/OTA)"
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "динамический бедренный винт (DHS)",
                                 "пластина",
                                 "винты для фиксации пластины к кости"
                              ]
                           }
                        },
                        {
                           "name":"Интрамедуллярный блокируемый остеосинтез проксимальным бедренным штифтом (стержнем)",
                           "criteria":{
                              "indications":[
                                 "Хирургическое лечение нестабильных чрезвертельных переломов проксимального отдела бедренной кости",
                                 "Переломы типа 31А1.3 по классификации AO/OTA (простой чрезвертельный перелом с интактной латеральной стенкой)",
                                 "Переломы типа 31А2 по классификации AO/OTA (оскольчатые чрезвертельные переломы с повреждением медиальной кортикальной поверхности)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "проксимальный бедренный штифт (стержень)",
                                 "шеечный элемент (например, шейно-диафизарный винт)",
                                 "блокирующие винты для фиксации стержня в костномозговом канале"
                              ]
                           }
                        },
                        {
                           "name":"Эндопротезирование",
                           "criteria":{
                              "indications":[
                                 "Пациенты старше 60 лет",
                                 "Стабильные чрезвертельные переломы (например, типа 31А1.2)",
                                 "Наличие сопутствующего коксартроза 3-й стадии",
                                 "Возможность установки первичной (стандартной) ножки эндопротеза в бедренную кость"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "первичная (стандартная) ножка эндопротеза"
                              ]
                           }
                        }
                     ]
                  },
                  {
                     "name_stage":"Послеоперационная реабилитация",
                     "methods":[
                        {
                           "name":"Дыхательные упражнения",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Активные упражнения для здоровой ноги",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Изометрические упражнения для мышц оперированной конечности",
                           "criteria":{
                              "indications":[
                                 "Ранний послеоперационный период после остеосинтеза при чрезвертельных переломах бедренной кости"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "Текст, описывающий метод Изометрические упражнения для мышц оперированной конечности"
                              ]
                           }
                        },
                        {
                           "name":"Приподнимание таза с опорой на локти и стопу оперированной ноги",
                           "criteria":{
                              "indications":[
                                 "остеосинтез чрезвертельного перелома бедренной кости",
                                 "ранний послеоперационный период",
                                 "профилактика пролежней",
                                 "укрепление мышц туловища, ягодичных мышц и мышц оперированной конечности",
                                 "улучшение кровообращения в области таза и оперированной конечности",
                                 "подготовка к дальнейшей активизации и вертикализации"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "локти (или предплечья)",
                                 "стопа оперированной ноги"
                              ]
                           }
                        },
                        {
                           "name":"«Вертикализация» пациента с использованием ходунков или костылей",
                           "criteria":{
                              "indications":[
                                 "чрезвертельный перелом бедренной кости после операции (остеосинтеза)",
                                 "ранняя активизация пациента в рамках послеоперационной реабилитации",
                                 "обучение ходьбе с использованием вспомогательных приспособлений"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "ходунки",
                                 "костыли"
                              ]
                           }
                        },
                        {
                           "name":"Обучение ходьбе",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "ходунки",
                                 "костыли"
                              ]
                           }
                        },
                        {
                           "name":"Повороты на живот",
                           "criteria":{
                              "indications":[
                                 "ранний послеоперационный период после хирургического лечения чрезвертельных переломов бедренной кости"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "подушка"
                              ]
                           }
                        },
                        {
                           "name":"Упражнения лежа на животе",
                           "criteria":{
                              "indications":[
                                 "реабилитация после хирургического лечения чрезвертельных переломов проксимального отдела бедренной кости (ППОБК) в ранний послеоперационный период (первые 1-2 недели), через неделю после операции"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "подушка"
                              ]
                           }
                        },
                        {
                           "name":"Лечебная гимнастика в зале ЛФК",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Медицинский массаж оперированной конечности",
                           "criteria":{
                              "indications":[
                                 "Период восстановления после остеосинтеза по поводу чрезвертельного перелома бедренной кости"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Физиотерапия (СМТ-терапия, магнитотерапия)",
                           "criteria":{
                              "indications":[
                                 "купирование болевого синдрома в послеоперационном периоде",
                                 "реабилитация пациентов после хирургического лечения чрезвертельных переломов бедренной кости"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Использование функциональной многоканальной стимуляции мышц (ФМСМ) во время ходьбы на беговой дорожке",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "функциональная многоканальная стимуляция мышц (ФМСМ) аппарат",
                                 "беговая дорожка",
                                 "электроды для многоканальной стимуляции"
                              ]
                           }
                        },
                        {
                           "name":"Лечебные ванны",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Подводный душ-массаж",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        }
                     ]
                  }
               ]
            },
            {
               "name":"Межвертельные переломы",
               "ICD-10_code":"S72.1",
               "general_indications":[
                  "Межвертельные переломы (АО/OTA тип 31А3), которые являются нестабильными",
                  "Пациенты старше 60 лет с поперечными и реверсивными косыми межвертельными переломами (АО/OTA 31-А3) при наличии третьей стадии коксартроза (показан остеосинтез, а не эндопротезирование)"
               ],
               "general_contraindications":[
                  "Отсутствие медицинских противопоказаний (подразумевается, что противопоказания включают состояния, препятствующие безопасному проведению операции, такие как нестабильные сопутствующие заболевания, неконтролируемые инфекции или тяжелые коагулопатии, хотя в тексте они не перечислены явно)"
               ],
               "stage":[
                  {
                     "name_stage":"Предоперационная подготовка",
                     "methods":[
                        {
                           "name":"Тромбопрофилактика венозных тромбоэмболических осложнений (ВТЭО)",
                           "criteria":{
                              "indications":[
                                 "всем пациентам с переломами проксимального отдела бедренной кости (ППОБК)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        }
                     ]
                  },
                  {
                     "name_stage":"Хирургическое лечение",
                     "methods":[
                        {
                           "name":"Проксимальные бедренные штифты (интрамедуллярные стержни)",
                           "criteria":{
                              "indications":[
                                 "Хирургическая фиксация нестабильных межвертельных переломов типа АО/OTA 31-А3 (реверсивные косые и поперечные переломы с двумя и более фрагментами)",
                                 "У пациентов старше 60 лет с поперечными и реверсивными косыми межвертельными переломами (АО/OTA 31-А3), при наличии сопутствующего коксартроза 3-й стадии"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "Проксимальные бедренные штифты (интрамедуллярные стержни)",
                                 "Короткая версия штифта (не рекомендуется для переломов типа 31.А.3 из-за высокого риска периимплантного перелома)"
                              ]
                           }
                        },
                        {
                           "name":"Остеосинтез",
                           "criteria":{
                              "indications":[
                                 "Лечение межвертельных переломов (тип АО/OTA 31-А3)",
                                 "У пациентов старше 60 лет с поперечными и реверсивными косыми межвертельными переломами (АО/OTA 31-А3) при наличии третьей стадии коксартроза"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "Проксимальные бедренные штифты (интрамедуллярные стержни)",
                                 "Короткая версия штифта (упоминается как нежелательная из-за высокого риска периимплантного перелома)",
                                 "Динамический бедренный винт (DHS) (упоминается как альтернатива, но менее предпочтительный)"
                              ]
                           }
                        }
                     ]
                  },
                  {
                     "name_stage":"Послеоперационная реабилитация",
                     "methods":[
                        {
                           "name":"Статическая фиксация",
                           "criteria":{
                              "indications":[
                                 "Пациенты моложе 60 лет с межвертельными переломами типа АО/OTA 31-А3 после остеосинтеза"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "проксимальный бедренный штифт (интрамедуллярный стержень)"
                              ]
                           }
                        },
                        {
                           "name":"Динамическая фиксация",
                           "criteria":{
                              "indications":[
                                 "Пациенты старше 60 лет после хирургического лечения межвертельных переломов (АО/OTA 31-А3)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "интрамедуллярный штифт",
                                 "динамический бедренный винт",
                                 "проксимальные бедренные штифты (интрамедуллярные стержни)"
                              ]
                           }
                        },
                        {
                           "name":"Дыхательные упражнения",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Активные упражнения для здоровой ноги",
                           "criteria":{
                              "indications":[
                                 "ранняя реабилитация в послеоперационном периоде после хирургического лечения межвертельных переломов бедренной кости",
                                 "первые 1-2 недели после операции"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Изометрические упражнения для мышц оперированной конечности",
                           "criteria":{
                              "indications":[
                                 "межвертельные переломы бедренной кости (тип АО/OTA 31-А3)",
                                 "послеоперационная реабилитация",
                                 "ранняя реабилитация в первые 1-2 недели после операции",
                                 "поддержание и профилактика атрофии мышечного тонуса оперированной конечности",
                                 "улучшение местного кровообращения для уменьшения послеоперационного отека",
                                 "профилактика тромбоэмболических осложнений",
                                 "подготовка мышц (четырехглавой мышцы бедра и ягодичных) к осевой нагрузке и ходьбе",
                                 "начало упражнений в течение первых 24 часов после операции",
                                 "выполнение в постели в рамках начального этапа мобилизации"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Обучение присаживанию в кровати",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "руки (упор на локти)",
                                 "здоровая нога",
                                 "кровать"
                              ]
                           }
                        },
                        {
                           "name":"Вертикализация с помощью ходунков или костылей",
                           "criteria":{
                              "indications":[
                                 "межвертельные переломы бедренной кости после хирургического лечения",
                                 "ранняя реабилитация после операции",
                                 "профилактика послеоперационных осложнений (пролежней, тромбозов, пневмонии)",
                                 "уменьшение отека оперированной конечности",
                                 "подготовка к самостоятельному передвижению",
                                 "обучение ходьбе"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "ходунки",
                                 "костыли"
                              ]
                           }
                        },
                        {
                           "name":"Обучение ходьбе",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "ходунки",
                                 "костыли"
                              ]
                           }
                        },
                        {
                           "name":"Лечебная гимнастика в зале",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Механотерапия",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Медицинский массаж",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Физиотерапия (СМТ-терапия, магнитотерапия)",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"Функциональная многоканальная стимуляция мышц (ФМСМ) во время ходьбы",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "электростимулятор",
                                 "многоканальный электродный аппарат",
                                 "электроды для стимуляции мышц"
                              ]
                           }
                        }
                     ]
                  }
               ]
            },
            {
               "name":"Подвертельные переломы",
               "ICD-10_code":"S72.2",
               "general_indications":[
                  "Подвертельные переломы (кодировка по МКБ-10: S72.2, классификация АО/OTA: 32A/B/C (1-3).1)",
                  "Пациенты старше 60 лет (рекомендуется выполнение остеосинтеза не позднее 48 часов после поступления при отсутствии медицинских противопоказаний)",
                  "Пациенты моложе 50 лет (при невозможности выполнить окончательную фиксацию в течение 12 часов после поступления, рекомендуется наложение стержневого аппарата внешней фиксации для стабилизации костных фрагментов)"
               ],
               "general_contraindications":[
                  "Медицинские противопоказания (не указаны конкретно в тексте, но упоминаются как условие для отсрочки операции у пациентов старше 60 лет)"
               ],
               "stage":[
                  {
                     "name_stage":"Предоперационный период",
                     "methods":[
                        {
                           "name":"наложение скелетного вытяжения",
                           "criteria":{
                              "indications":[
                                 "Пациенты старше 50 лет с подвертельными переломами (классификация 32А/В/С.1 по АО/ОТА) в качестве предоперационной иммобилизации"
                              ],
                              "contraindications":[
                                 "Пациенты старше 50 лет с переломами проксимального отдела бедренной кости (ППОБК), кроме подвертельных переломов",
                                 "Взрослые пациенты моложе 50 лет (вместо этого рекомендуется стержневой аппарат внешней фиксации)"
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"наложение стержневого аппарата внешней фиксации костей таза, бедренной кости",
                           "criteria":{
                              "indications":[
                                 "Взрослые пациенты моложе 50 лет с подвертельными переломами бедренной кости, когда невозможно выполнить окончательную фиксацию перелома (остеосинтез проксимальным бедренным стержнем) в течение 12 часов после поступления пациента в стационар"
                              ],
                              "contraindications":[
                                 "Пациенты старше 50 лет с подвертельными переломами (за исключением переломов типа 32А/В/С.1 по АО/OTA)"
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "стержневой аппарат внешней фиксации",
                                 "стержни для внешней фиксации",
                                 "фиксирующие элементы (например, винты или спицы)",
                                 "внешние соединительные элементы (например, стержни или рамы)",
                                 "инструменты для установки (например, дрель, отвертки)"
                              ]
                           }
                        }
                     ]
                  },
                  {
                     "name_stage":"Хирургическое лечение",
                     "methods":[
                        {
                           "name":"применение проксимальных бедренных стержней (интрамедуллярных бедренных стержней)",
                           "criteria":{
                              "indications":[
                                 "Хирургическое лечение подвертельных переломов (классификация АО/OTA: 32A/B/C.1)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 "проксимальные бедренные стержни (интрамедуллярные бедренные стержни)"
                              ]
                           }
                        }
                     ]
                  },
                  {
                     "name_stage":"Послеоперационное восстановление (Реабилитация)",
                     "methods":[
                        {
                           "name":"дыхательные упражнения",
                           "criteria":{
                              "indications":[
                                 "профилактика осложнений со стороны дыхательной системы, в частности, послеоперационной пневмонии",
                                 "ранняя послеоперационная мобилизация для профилактики пневмонии у пациентов, перенесших остеосинтез по поводу подвертельного перелома бедра"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"активные упражнения для здоровой ноги",
                           "criteria":{
                              "indications":[
                                 
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"изометрические упражнения для мышц оперированной конечности",
                           "criteria":{
                              "indications":[
                                 "реабилитация после хирургического лечения подвертельных переломов бедренной кости",
                                 "ранний послеоперационный период (первые 1-2 недели после операции)"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"обучение присаживанию в кровати",
                           "criteria":{
                              "indications":[
                                 "ранний послеоперационный период (первые 1-2 недели) после хирургического лечения подвертельных переломов бедренной кости"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"лечебная гимнастика в зале",
                           "criteria":{
                              "indications":[
                                 "Пациенты в позднем послеоперационном периоде после остеосинтеза подвертельного перелома"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"механотерапия",
                           "criteria":{
                              "indications":[
                                 "реабилитация после хирургического лечения подвертельных переломов бедренной кости",
                                 "поздний послеоперационный период",
                                 "восстановление функции опоры, передвижения и навыков самообслуживания"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"медицинский массаж оперированной конечности",
                           "criteria":{
                              "indications":[
                                 "подвертельные переломы бедренной кости после хирургического лечения",
                                 "поздний послеоперационный период реабилитации",
                                 "необходимость восстановления функции опоры и передвижения",
                                 "улучшение крово- и лимфообращения в оперированной конечности",
                                 "снижение послеоперационного отека",
                                 "профилактика мышечной гипотрофии (атрофии)",
                                 "улучшение трофики (питания) тканей",
                                 "подготовка мышц к активной работе в рамках лечебной гимнастики"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        },
                        {
                           "name":"физиотерапия (СМТ-терапия, магнитотерапия)",
                           "criteria":{
                              "indications":[
                                 "при наличии болевого синдрома"
                              ],
                              "contraindications":[
                                 
                              ]
                           },
                           "materials":{
                              "used material":[
                                 
                              ]
                           }
                        }
                     ]
                  }
               ]
            }
         ]
      }
   ]
}

    def load_knowledge_base(self, filepath: str):
        """Загрузка базы знаний из JSON файла"""
        with open(filepath, 'r', encoding='utf-8') as f:
            self.knowledge_base = json.load(f)

    def get_diseases(self) -> List[str]:
        """Получение списка доступных заболеваний"""
        diseases = []
        for disease in self.knowledge_base["disease"]:
            diseases.append(disease["name"])
        return diseases

    def get_disease_variants(self, disease_name: str) -> List[Dict]:
        """Получение вариантов заболевания"""
        for disease in self.knowledge_base["disease"]:
            if disease["name"] == disease_name:
                return disease["type_variant"]
        return []

    def get_treatment_plan(self, disease_name: str, variant_name: str) -> Dict:
        """Получение плана лечения для конкретного варианта заболевания"""
        for disease in self.knowledge_base["disease"]:
            if disease["name"] == disease_name:
                for variant in disease["type_variant"]:
                    if variant["name"] == variant_name:
                        return {
                            "disease": disease_name,
                            "variant": variant_name,
                            "icd10": variant["ICD-10_code"],
                            "general_indications": variant["general_indications"],
                            "general_contraindications": variant["general_contraindications"],
                            "stages": variant["stage"]
                        }
        return {}

    def search_methods_by_keyword(self, keyword: str) -> List[Dict]:
        """Поиск методов лечения по ключевому слову"""
        results = []
        keyword_lower = keyword.lower()

        for disease in self.knowledge_base["disease"]:
            for variant in disease["type_variant"]:
                for stage in variant["stage"]:
                    for method in stage["methods"]:
                        # Поиск в названии метода
                        if keyword_lower in method["name"].lower():
                            results.append({
                                "disease": disease["name"],
                                "variant": variant["name"],
                                "stage": stage["name_stage"],
                                "method": method["name"],
                                "indications": method["criteria"]["indications"],
                                "contraindications": method["criteria"]["contraindications"],
                                "materials": method["materials"]["used material"]
                            })
                        # Поиск в показаниях
                        for indication in method["criteria"]["indications"]:
                            if keyword_lower in indication.lower():
                                results.append({
                                    "disease": disease["name"],
                                    "variant": variant["name"],
                                    "stage": stage["name_stage"],
                                    "method": method["name"],
                                    "indications": method["criteria"]["indications"],
                                    "contraindications": method["criteria"]["contraindications"],
                                    "materials": method["materials"]["used material"]
                                })
                                break
        return results


def main():
    """Основная функция Streamlit приложения"""
    st.set_page_config(
        page_title="Система планирования лечения в травматологии",
        page_icon="🏥",
        layout="wide"
    )

    # Инициализация системы
    if 'planner' not in st.session_state:
        st.session_state.planner = TreatmentPlanner()

    planner = st.session_state.planner

    # Заголовок приложения
    st.title("🏥 База знаний для планирования лечения в травматологии и ортопедии")
    st.markdown("---")

    # Сайдбар с навигацией
    with st.sidebar:
        st.header("Навигация")
        app_mode = st.radio(
            "Выберите режим работы:",
            ["Планирование лечения", "Поиск методов", "База знаний"]
        )

        st.markdown("---")
        st.info("""
        **Информация о системе:**

        Эта система помогает в планировании лечения 
        переломов бедренной кости на основе клинических 
        рекомендаций и протоколов.
        """)

    # Режим планирования лечения
    if app_mode == "Планирование лечения":
        st.header("Планирование лечения")

        col1, col2 = st.columns(2)

        with col1:
            # Выбор заболевания
            diseases = planner.get_diseases()
            selected_disease = st.selectbox(
                "Выберите заболевание:",
                diseases
            )

            # Выбор варианта заболевания
            if selected_disease:
                variants = planner.get_disease_variants(selected_disease)
                variant_names = [v["name"] for v in variants]

                if variant_names:
                    selected_variant = st.selectbox(
                        "Выберите тип перелома:",
                        variant_names
                    )

        with col2:
            # Информация о выбранном варианте
            if selected_disease and selected_variant:
                variant_info = next(
                    (v for v in planner.get_disease_variants(selected_disease)
                     if v["name"] == selected_variant),
                    None
                )

                if variant_info:
                    st.subheader("📋 Общая информация")
                    st.write(f"**Код МКБ-10:** {variant_info['ICD-10_code']}")

                    with st.expander("Показания к лечению"):
                        for indication in variant_info['general_indications']:
                            st.write(f"• {indication}")

                    with st.expander("Противопоказания"):
                        if variant_info['general_contraindications']:
                            for contraindication in variant_info['general_contraindications']:
                                st.write(f"• {contraindication}")
                        else:
                            st.write("Противопоказания не указаны")

        # Отображение плана лечения
        if selected_disease and selected_variant:
            st.markdown("---")
            st.header("📋 План лечения")

            treatment_plan = planner.get_treatment_plan(selected_disease, selected_variant)

            if treatment_plan:
                # Создаем табы для каждого этапа лечения
                tabs = st.tabs([stage["name_stage"] for stage in treatment_plan["stages"]])

                for i, tab in enumerate(tabs):
                    with tab:
                        stage = treatment_plan["stages"][i]
                        st.subheader(stage["name_stage"])

                        if stage["methods"]:
                            for method in stage["methods"]:
                                with st.expander(f"📌 {method['name']}"):
                                    # Показания
                                    if method['criteria']['indications']:
                                        st.write("**Показания:**")
                                        for indication in method['criteria']['indications']:
                                            st.write(f"• {indication}")
                                    else:
                                        st.write("**Показания:** не указаны")

                                    # Противопоказания
                                    if method['criteria']['contraindications']:
                                        st.write("**Противопоказания:**")
                                        for contraindication in method['criteria']['contraindications']:
                                            st.write(f"• {contraindication}")
                                    else:
                                        st.write("**Противопоказания:** не указаны")

                                    # Материалы и оборудование
                                    if method['materials']['used material']:
                                        st.write("**Используемые материалы:**")
                                        for material in method['materials']['used material']:
                                            st.write(f"• {material}")
                                    else:
                                        st.write("**Используемые материалы:** не указаны")
                        else:
                            st.info("Методы лечения для этого этапа не указаны")

            # Кнопка для генерации отчета
            if st.button("📄 Сгенерировать отчет о лечении"):
                generate_treatment_report(treatment_plan)

    # Режим поиска методов
    elif app_mode == "Поиск методов":
        st.header("🔍 Поиск методов лечения")

        search_term = st.text_input(
            "Введите ключевое слово для поиска:",
            placeholder="Например: остеосинтез, профилактика, реабилитация..."
        )

        if search_term:
            results = planner.search_methods_by_keyword(search_term)

            if results:
                st.write(f"Найдено результатов: {len(results)}")

                for result in results:
                    with st.expander(f"{result['method']} ({result['disease']} - {result['stage']})"):
                        st.write(f"**Заболевание:** {result['disease']}")
                        st.write(f"**Тип:** {result['variant']}")
                        st.write(f"**Этап:** {result['stage']}")

                        if result['indications']:
                            st.write("**Показания:**")
                            for indication in result['indications']:
                                st.write(f"• {indication}")

                        if result['materials']:
                            st.write("**Материалы:**")
                            for material in result['materials']:
                                st.write(f"• {material}")
            else:
                st.warning("По вашему запросу ничего не найдено")

    # Режим просмотра базы знаний
    elif app_mode == "База знаний":
        st.header("📚 База знаний")

        # Отображение структуры базы знаний
        for disease in planner.knowledge_base["disease"]:
            with st.expander(f"📁 {disease['name']}", expanded=True):
                for variant in disease["type_variant"]:
                    st.subheader(f"📄 {variant['name']} (МКБ-10: {variant['ICD-10_code']})")

                    # Статистика по методам
                    total_methods = 0
                    for stage in variant["stage"]:
                        total_methods += len(stage["methods"])

                    col1, col2, col3 = st.columns(3)
                    with col1:
                        st.metric("Этапов лечения", len(variant["stage"]))
                    with col2:
                        st.metric("Всего методов", total_methods)
                    with col3:
                        st.metric("Показаний", len(variant["general_indications"]))

                    # Детальная информация по этапам
                    for stage in variant["stage"]:
                        st.write(f"**{stage['name_stage']}** ({len(stage['methods'])} методов)")


def generate_treatment_report(treatment_plan: Dict):
    """Генерация отчета о лечении"""
    report_text = f"""
    # ОТЧЕТ О ПЛАНЕ ЛЕЧЕНИЯ

    ## Основная информация
    **Заболевание:** {treatment_plan['disease']}
    **Тип перелома:** {treatment_plan['variant']}
    **Код МКБ-10:** {treatment_plan['icd10']}

    ## Общие показания
    {chr(10).join(f'• {ind}' for ind in treatment_plan['general_indications'])}

    ## Общие противопоказания
    {chr(10).join(f'• {contra}' for contra in treatment_plan['general_contraindications']) if treatment_plan['general_contraindications'] else 'Не указаны'}

    ## План лечения
    """

    for stage in treatment_plan['stages']:
        report_text += f"\n### {stage['name_stage']}\n"

        for method in stage['methods']:
            report_text += f"\n**{method['name']}**\n"

            if method['criteria']['indications']:
                report_text += "Показания:\n"
                for ind in method['criteria']['indications']:
                    report_text += f"• {ind}\n"

            if method['materials']['used material']:
                report_text += "Материалы:\n"
                for material in method['materials']['used material']:
                    report_text += f"• {material}\n"

    # Отображение отчета
    st.markdown("---")
    st.header("📄 Сгенерированный отчет")
    st.markdown(report_text)

    # Кнопка для скачивания
    st.download_button(
        label="📥 Скачать отчет",
        data=report_text,
        file_name=f"treatment_plan_{treatment_plan['variant'].replace(' ', '_')}.md",
        mime="text/markdown"
    )


if __name__ == "__main__":

    main()

